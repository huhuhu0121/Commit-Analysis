<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GitHub ì»¤ë°‹ ë¶„ì„ê¸°</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸš€ GitHub ì»¤ë°‹ ë¶„ì„ê¸°</h1>
        <p>AIë¡œ ì»¤ë°‹ íˆìŠ¤í† ë¦¬ë¥¼ ë¶„ì„í•˜ê³  ê°œì„ ì ì„ ì°¾ì•„ë³´ì„¸ìš”</p>
      </div>

      <div class="content">
        <div class="form-section">
          <div class="form-group">
            <label for="repoUrl">ğŸ“ GitHub ë¦¬í¬ì§€í† ë¦¬ URL</label>
            <input id="repoUrl" type="text" placeholder="https://github.com/owner/repo" />
            <div class="muted">ê³µê°œ ì €ì¥ì†ŒëŠ” í† í° ì—†ì´ë„ ê°€ëŠ¥í•˜ë‚˜, ì†ë„/ì¿¼í„° ê´€ì ì—ì„œ ì„œë²„ì— GITHUB_TOKEN ì„¤ì •ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</div>
          </div>

          <div class="form-group">
            <label for="branch">ğŸŒ¿ ë¸Œëœì¹˜ ì„ íƒ</label>
            <select id="branch">
              <option value="">ê¸°ë³¸ ë¸Œëœì¹˜ (main/master)</option>
            </select>
            <div class="muted">ë¸Œëœì¹˜ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ë¸Œëœì¹˜ì˜ ì»¤ë°‹ë§Œ ì¡°íšŒë©ë‹ˆë‹¤.</div>
          </div>

          

          <div class="button-group">
            <button id="loadCommits" class="btn-primary">ğŸ“¥ ì»¤ë°‹ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>
        </div>

        <div class="commits-section" id="commitsSection" style="display: none;">
          <div class="commits-header">
            <div class="commits-title">ğŸ“‹ ì»¤ë°‹ ëª©ë¡</div>
            <div class="pagination" id="pagination"></div>
          </div>
          <div id="commits"></div>
        </div>

        
      </div>
    </div>

    <!-- ì»¤ë°‹ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="commitModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ğŸ“‹ ì»¤ë°‹ ìƒì„¸ ë‚´ì—­</h2>
          <button class="modal-close" onclick="closeCommitModal()">&times;</button>
        </div>
        <div class="modal-body" id="commitModalBody">
          <!-- ì»¤ë°‹ ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      let lastCommits = [];
      let currentPage = 1;
      let paginationInfo = null;
      let currentRepoUrl = '';
      const API_BASE = 'http://localhost:3000';

      async function loadBranches() {
        const repoUrl = $('repoUrl').value.trim();
        if (!repoUrl) return;
        
        try {
          const url = `${API_BASE}/api/branches?repoUrl=${encodeURIComponent(repoUrl)}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          
          const branchSelect = $('branch');
          branchSelect.innerHTML = '<option value="">ê¸°ë³¸ ë¸Œëœì¹˜ (main/master)</option>';
          
          data.branches.forEach(branch => {
            const option = document.createElement('option');
            option.value = branch.name;
            option.textContent = `${branch.name}${branch.protected ? ' ğŸ”’' : ''}`;
            branchSelect.appendChild(option);
          });
          
        } catch (err) {
          console.error('ë¸Œëœì¹˜ ë¡œë”© ì‹¤íŒ¨:', err);
        }
      }

      async function fetchCommits(page = 1) {
        const repoUrl = $('repoUrl').value.trim();
        if (!repoUrl) { 
          alert('ë¦¬í¬ì§€í† ë¦¬ URLì„ ì…ë ¥í•˜ì„¸ìš”.'); 
          return; 
        }
        
        currentRepoUrl = repoUrl;
        const branch = $('branch').value;
        let url = `${API_BASE}/api/commits?repoUrl=${encodeURIComponent(repoUrl)}&per_page=10&page=${page}`;
        if (branch) url += `&branch=${encodeURIComponent(branch)}`;
        
        $('loadCommits').disabled = true;
        $('loadCommits').classList.add('loading');
        $('commits').innerHTML = '<div class="empty-state">ë¡œë”© ì¤‘...</div>';
        
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          
          lastCommits = data.commits || [];
          paginationInfo = data.pagination;
          currentPage = page;
          
          $('commitsSection').style.display = lastCommits.length > 0 ? 'block' : 'none';
          
          renderCommits();
          renderPagination();
          
        } catch (err) {
          $('commits').innerHTML = `<div class="error">ì—ëŸ¬: ${err.message}</div>`;
        } finally {
          $('loadCommits').disabled = false;
          $('loadCommits').classList.remove('loading');
        }
      }

      function renderCommits() {
        if (lastCommits.length === 0) {
          $('commits').innerHTML = '<div class="empty-state">ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        $('commits').innerHTML = lastCommits.map(c => `
          <div class="commit-card" onclick="showCommitDetail('${c.sha}')" style="cursor: pointer;">
            <div class="commit-header">
              <div class="commit-sha">${(c.sha||'').slice(0,7)}</div>
              <div class="commit-date">${formatDate(c.date)}</div>
            </div>
            <div class="commit-author">ğŸ‘¤ ${c.authorName || 'Unknown'}</div>
            <div class="commit-message">${escapeHtml(c.message || '')}</div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
              <span style="color: #667eea; font-size: 0.9rem;">ğŸ“‹ í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°</span>
              <a href="${c.url}" target="_blank" rel="noreferrer noopener" class="commit-link" onclick="event.stopPropagation()">
                ğŸ”— GitHubì—ì„œ ë³´ê¸° â†’
              </a>
            </div>
          </div>
        `).join('');
      }

      function renderPagination() {
        if (!paginationInfo) return;
        
        const { currentPage, hasNext, hasPrev, totalPages } = paginationInfo;
        const pagination = $('pagination');
        
        pagination.innerHTML = `
          <button ${!hasPrev ? 'disabled' : ''} onclick="fetchCommits(${currentPage - 1})" class="btn-primary">
            â† ì´ì „
          </button>
          <div class="page-info">${currentPage} / ${totalPages}</div>
          <button ${!hasNext ? 'disabled' : ''} onclick="fetchCommits(${currentPage + 1})" class="btn-primary">
            ë‹¤ìŒ â†’
          </button>
        `;
      }

      

      function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('ko-KR', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      async function showCommitDetail(sha) {
        if (!currentRepoUrl) return;
        
        const modal = $('commitModal');
        const modalBody = $('commitModalBody');
        
        modal.style.display = 'flex';
        modalBody.innerHTML = '<div class="empty-state">ë¡œë”© ì¤‘...</div>';
        
        try {
          const url = `${API_BASE}/api/commit-detail?repoUrl=${encodeURIComponent(currentRepoUrl)}&sha=${sha}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          
          const commit = data.commit;
          modalBody.innerHTML = `
            <div class="commit-detail">
              <div class="commit-detail-header">
                <div class="commit-sha-large">${commit.sha.slice(0,7)}</div>
                <div class="commit-date">${formatDate(commit.author.date)}</div>
              </div>
              
              <div class="commit-message-large">${escapeHtml(commit.message)}</div>
              
              <div class="commit-author-info">
                ${commit.author.avatar ? `<img src="${commit.author.avatar}" alt="Avatar" class="author-avatar">` : '<div class="author-avatar" style="background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">ğŸ‘¤</div>'}
                <div class="author-details">
                  <h4>${commit.author.name || commit.author.login || 'Unknown'}</h4>
                  <p>${commit.author.email || ''}</p>
                  <p>${commit.author.login ? `@${commit.author.login}` : ''}</p>
                </div>
              </div>
              
              ${commit.stats ? `
                <div class="commit-stats">
                  <div class="stat-item">
                    <span class="stat-number additions">+${commit.stats.additions}</span>
                    <span class="stat-label">ì¶”ê°€</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-number deletions">-${commit.stats.deletions}</span>
                    <span class="stat-label">ì‚­ì œ</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-number changes">${commit.stats.total}</span>
                    <span class="stat-label">ì´ ë³€ê²½</span>
                  </div>
                </div>
              ` : ''}
              
              ${commit.files && commit.files.length > 0 ? `
                <div class="commit-files">
                  <div class="files-title">ğŸ“ ë³€ê²½ëœ íŒŒì¼ (${commit.files.length}ê°œ)</div>
                  ${commit.files.map(file => `
                    <div class="file-item">
                      <div class="file-name">${file.filename}</div>
                      <div class="file-stats">
                        <span class="file-status status-${file.status}">${file.status}</span>
                        ${file.additions > 0 ? `<span class="additions">+${file.additions}</span>` : ''}
                        ${file.deletions > 0 ? `<span class="deletions">-${file.deletions}</span>` : ''}
                        <span class="changes">${file.changes} ë³€ê²½</span>
                      </div>
                      ${file.patch ? `
                        <button class="code-toggle" onclick="toggleCodeDiff('${file.filename.replace(/[^a-zA-Z0-9]/g, '_')}')">
                          ğŸ“ ì½”ë“œ ë³€ê²½ì‚¬í•­ ë³´ê¸°
                        </button>
                        <div class="code-diff collapsed" id="diff_${file.filename.replace(/[^a-zA-Z0-9]/g, '_')}">
                          <div class="code-diff-header">
                            ${file.filename} - ${file.additions} ì¶”ê°€, ${file.deletions} ì‚­ì œ
                          </div>
                          <div class="code-diff-content">
                            ${parsePatch(file.patch)}
                          </div>
                        </div>
                      ` : ''}
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              
              <div style="margin-top: 20px; text-align: center;">
                <a href="${commit.url}" target="_blank" rel="noreferrer noopener" class="commit-link">
                  ğŸ”— GitHubì—ì„œ ì „ì²´ ë³´ê¸° â†’
                </a>
              </div>
              
              <div class="commit-analysis-section">
                <div class="analysis-title">AI ë¶„ì„</div>
                <div class="analysis-controls">
                  <select id="modalAnalysisMode" class="analysis-mode-select">
                    <option value="summary">ğŸ“Š ìš”ì•½ ë¶„ì„</option>
                    <option value="feedback">ğŸ’¡ í”¼ë“œë°± ë¶„ì„</option>
                  </select>
                  <button class="btn-secondary" onclick="analyzeSingleCommit('${commit.sha}')">
                    ì´ ì»¤ë°‹ ë¶„ì„í•˜ê¸°
                  </button>
                </div>
                <div id="modalAnalysisResult" class="analysis-result" style="display: none;"></div>
              </div>
            </div>
          `;
          
        } catch (err) {
          modalBody.innerHTML = `<div class="error">ì—ëŸ¬: ${err.message}</div>`;
        }
      }

      function closeCommitModal() {
        $('commitModal').style.display = 'none';
      }

      function parsePatch(patch) {
        if (!patch) return '';
        
        const lines = patch.split('\n');
        let result = '';
        let oldLineNum = 0;
        let newLineNum = 0;
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          if (line.startsWith('@@')) {
            // í—¤ë” ë¼ì¸: @@ -oldStart,oldCount +newStart,newCount @@
            const match = line.match(/@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@/);
            if (match) {
              oldLineNum = parseInt(match[1]);
              newLineNum = parseInt(match[3]);
            }
            result += `<div class="diff-line diff-line-context">
              <div class="diff-line-number">...</div>
              <div class="diff-line-content">${escapeHtml(line)}</div>
            </div>`;
          } else if (line.startsWith('+')) {
            // ì¶”ê°€ëœ ë¼ì¸
            result += `<div class="diff-line diff-line-added">
              <div class="diff-line-number">${newLineNum}</div>
              <div class="diff-line-content">${escapeHtml(line.substring(1))}</div>
            </div>`;
            newLineNum++;
          } else if (line.startsWith('-')) {
            // ì‚­ì œëœ ë¼ì¸
            result += `<div class="diff-line diff-line-deleted">
              <div class="diff-line-number">${oldLineNum}</div>
              <div class="diff-line-content">${escapeHtml(line.substring(1))}</div>
            </div>`;
            oldLineNum++;
          } else if (line.startsWith('\\')) {
            // ë°±ìŠ¬ë˜ì‹œë¡œ ì‹œì‘í•˜ëŠ” íŠ¹ìˆ˜ ë¼ì¸ (íŒŒì¼ ë ë“±)
            result += `<div class="diff-line diff-line-context">
              <div class="diff-line-number"></div>
              <div class="diff-line-content">${escapeHtml(line)}</div>
            </div>`;
          } else {
            // ì»¨í…ìŠ¤íŠ¸ ë¼ì¸ (ë³€ê²½ ì—†ìŒ)
            result += `<div class="diff-line diff-line-context">
              <div class="diff-line-number">${oldLineNum}</div>
              <div class="diff-line-content">${escapeHtml(line)}</div>
            </div>`;
            oldLineNum++;
            newLineNum++;
          }
        }
        
        return result;
      }

      function toggleCodeDiff(fileId) {
        const diffElement = document.getElementById(`diff_${fileId}`);
        if (diffElement) {
          diffElement.classList.toggle('collapsed');
          const button = diffElement.previousElementSibling;
          if (diffElement.classList.contains('collapsed')) {
            button.textContent = 'ğŸ“ ì½”ë“œ ë³€ê²½ì‚¬í•­ ë³´ê¸°';
          } else {
            button.textContent = 'ğŸ“ ì½”ë“œ ë³€ê²½ì‚¬í•­ ìˆ¨ê¸°ê¸°';
          }
        }
      }

      async function analyzeSingleCommit(sha) {
        const mode = document.getElementById('modalAnalysisMode').value;
        const resultDiv = document.getElementById('modalAnalysisResult');
        const button = event.target;
        
        button.disabled = true;
        button.classList.add('loading');
        resultDiv.style.display = 'block';
        resultDiv.textContent = 'ğŸ¤– AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...';
        
        try {
          const res = await fetch(`${API_BASE}/api/commit-analysis`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              mode, 
              repoUrl: currentRepoUrl,
              commits: [{ 
                sha: sha,
                authorName: lastCommits.find(c => c.sha === sha)?.authorName || 'Unknown',
                message: lastCommits.find(c => c.sha === sha)?.message || '',
                date: lastCommits.find(c => c.sha === sha)?.date || ''
              }],
              singleCommit: true
            })
          });
          
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          resultDiv.textContent = data.result || '(ë¹ˆ ì‘ë‹µ)';
          
        } catch (err) {
          resultDiv.textContent = `âŒ ì—ëŸ¬: ${err.message}`;
        } finally {
          button.disabled = false;
          button.classList.remove('loading');
        }
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      $('loadCommits').addEventListener('click', () => fetchCommits(1));
      
      
      // Enter í‚¤ë¡œ ì»¤ë°‹ ë¶ˆëŸ¬ì˜¤ê¸°
      $('repoUrl').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          loadBranches();
          fetchCommits(1);
        }
      });
      
      // URL ì…ë ¥ ì‹œ ë¸Œëœì¹˜ ìë™ ë¡œë”©
      $('repoUrl').addEventListener('blur', loadBranches);
      
      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      $('commitModal').addEventListener('click', (e) => {
        if (e.target === $('commitModal')) {
          closeCommitModal();
        }
      });
    </script>
  </body>
</html>